steps:
# Build the Docker image for the backend
- name: 'gcr.io/cloud-builders/docker'
  id: 'Build Backend Image'
  args: ['build', '-t', 'us-central1-docker.pkg.dev/$PROJECT_ID/flask-app/backend-$SHORT_SHA', '.']
  dir: './backend'

# Build the Docker image for the frontend
- name: 'gcr.io/cloud-builders/docker'
  id: 'Build Frontend Image'
  args: ['build', '-t', 'us-central1-docker.pkg.dev/$PROJECT_ID/flask-app/frontend-$SHORT_SHA', '.']
  dir: './frontend'

# Push the backend image
- name: 'gcr.io/cloud-builders/docker'
  id: 'Push Backend Image'
  args: ['push', 'us-central1-docker.pkg.dev/$PROJECT_ID/flask-app/backend-$SHORT_SHA']

# Push the frontend image
- name: 'gcr.io/cloud-builders/docker'
  id: 'Push Frontend Image'
  args: ['push', 'us-central1-docker.pkg.dev/$PROJECT_ID/flask-app/frontend-$SHORT_SHA']

# Get GKE credentials
- name: 'gcr.io/cloud-builders/gcloud'
  id: 'Get GKE Credentials'
  entrypoint: 'gcloud'
  args:
    - 'container'
    - 'clusters'
    - 'get-credentials'
    - 'web-app-cluster'
    - '--zone=us-central1-a'

# Update backend deployment
- name: 'gcr.io/cloud-builders/kubectl'
  id: 'Update Backend Deployment'
  args:
    - 'set'
    - 'image'
    - 'deployment/backend-deployment'
    - 'flask-backend-container=us-central1-docker.pkg.dev/$PROJECT_ID/flask-app/backend-$SHORT_SHA'
    - '--namespace=default'
  env:
    - 'CLOUDSDK_COMPUTE_ZONE=us-central1-a'
    - 'CLOUDSDK_CONTAINER_CLUSTER=web-app-cluster'

# Update frontend deployment
- name: 'gcr.io/cloud-builders/kubectl'
  id: 'Update Frontend Deployment'
  args:
    - 'set'
    - 'image'
    - 'deployment/frontend-deployment'
    - 'nginx-frontend-container=us-central1-docker.pkg.dev/$PROJECT_ID/flask-app/frontend-$SHORT_SHA'
    - '--namespace=default'
  env:
    - 'CLOUDSDK_COMPUTE_ZONE=us-central1-a'
    - 'CLOUDSDK_CONTAINER_CLUSTER=web-app-cluster'

images:
- 'us-central1-docker.pkg.dev/$PROJECT_ID/flask-app/backend-$SHORT_SHA'
- 'us-central1-docker.pkg.dev/$PROJECT_ID/flask-app/frontend-$SHORT_SHA'

options:
  logging: CLOUD_LOGGING_ONLY